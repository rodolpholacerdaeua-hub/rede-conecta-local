rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }

    // ========================================
    // COLEÇÃO: users
    // ========================================
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ========================================
    // COLEÇÃO: campaigns
    // ========================================
    match /campaigns/{campaignId} {
      allow read: if isAuthenticated(); // Players precisam ler campanhas
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if (isOwner(resource.data.ownerId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ========================================
    // COLEÇÃO: media
    // ========================================
    match /media/{mediaId} {
      allow read: if isAuthenticated(); // Players precisam ler mídias
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if (isOwner(resource.data.ownerId) || isAdmin());
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }
    
    // ========================================
    // COLEÇÃO: terminals
    // ========================================
    match /terminals/{terminalId} {
      allow read: if isAuthenticated(); // Necessário para players e seleção
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      // Permitir que qualquer autenticado (incluindo anônimos) atualize heartbeat
      allow update: if isAuthenticated() && (
        // Players podem atualizar apenas campos de heartbeat/status/id
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastSeen', 'status', 'isOnline', 'hardwareId'])) ||
        // Owners e admins podem atualizar tudo
        isOwner(resource.data.ownerId) || 
        isAdmin()
      );
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }
    
    // ========================================
    // COLEÇÃO: playlists
    // ========================================
    match /playlists/{playlistId} {
      allow read: if isAuthenticated();
      // Temporariamente permitindo create para qualquer auth enquanto não adicionamos ownerId em todas as telas
      allow create: if isAuthenticated(); 
      allow update: if isAuthenticated(); // Idealmente check owner
      allow delete: if isAdmin();
    }

    // ========================================
    // COLEÇÃO: pairing_codes
    // ========================================
    match /pairing_codes/{codeId} {
      allow create, read: if isAuthenticated(); 
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ========================================
    // COLEÇÃO: playback_logs (Proof-of-Play)
    // ========================================
    match /playback_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if true;
    }

    // ========================================
    // V14: PROOF OF PLAY (Logs de Auditoria)
    // ========================================
    match /proof_of_play/{logId} {
      // Terminais podem criar logs (via sync)
      allow create: if isAuthenticated();
      // Atualizar apenas se for o mesmo terminal
      allow update: if isAuthenticated();
      // Leitura para admins e owners (para relatórios)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.terminalId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.terminals
      );
      // Delete only by admins (limpeza de logs antigos)
      allow delete: if isAdmin();
    }
    
    // ========================================
    // COLEÇÃO: terminal_groups
    // ========================================
    match /terminal_groups/{groupId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated(); // Idealmente isAdmin() mas liberando para clientes criarem seus grupos
      allow delete: if isAdmin();
    }

    // ========================================
    // COLEÇÃO: generation_requests (AI)
    // ========================================
    match /generation_requests/{requestId} {
      allow create: if isAuthenticated();
      allow read, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // REGRA PADRÃO: NEGAR TUDO
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
